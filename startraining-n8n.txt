============================================================
STARTRAINING N8N AUTOMATION - PROJECT STATUS
============================================================
Date: January 4, 2026 (Updated)
============================================================

GOAL
----
Automate the StarTraining workout publishing pipeline:
1. Detect new Word file uploaded to Google Drive
2. Run Python pipeline (Agents Aâ†’Bâ†’Câ†’D) to extract & format workout data
3. Create Canva design from template using the CSV data
4. Send the design image via WhatsApp

============================================================

WORKFLOW OVERVIEW
-----------------
Node 1:  Google Drive Trigger    â†’ Watch for new .docx files
Node 2:  Code                    â†’ Extract date & label from filename
Node 3:  HTTP Request            â†’ Call webhook_server.py to run pipeline
Node 4:  IF                      â†’ Check if pipeline succeeded
Node 5:  HTTP Request            â†’ Canva: Create design from template
Node 6:  Wait                    â†’ Wait for Canva to render
Node 7:  HTTP Request            â†’ Canva: Export design as PNG
Node 8:  Wait                    â†’ Wait for export
Node 9:  HTTP Request            â†’ Canva: Get export URL
Node 10: HTTP Request            â†’ WhatsApp: Send image

============================================================

DIRECTORY STRUCTURE
-------------------
Keep n8n and Python pipeline SEPARATE:

~/
â”œâ”€â”€ startraining-ai-pipeline/    â† Python scripts (your repo)
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ agentA.py
â”‚   â”‚   â”œâ”€â”€ agentB.py            â† Fixed: buffered CSV writing
â”‚   â”‚   â”œâ”€â”€ agentC.py
â”‚   â”‚   â””â”€â”€ agentD.py
â”‚   â”œâ”€â”€ webhook_server.py
â”‚   â”œâ”€â”€ run_pipeline.py
â”‚   â”œâ”€â”€ run_all_pipeline.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ .n8n/                        â† n8n data (auto-created by Docker)
â”‚   â”œâ”€â”€ database.sqlite          â† Workflows, credentials
â”‚   â””â”€â”€ config                   â† n8n settings
â”‚
â””â”€â”€ Google Drive/
    â””â”€â”€ Blackboard/
        â”œâ”€â”€ Raw/                 â† Upload .docx files here
        â”œâ”€â”€ AgentA/              â† AgentA output
        â”œâ”€â”€ AgentB/              â† AgentB output
        â”œâ”€â”€ AgentC/              â† AgentC output (pivoted)
        â””â”€â”€ AgentD/              â† AgentD output (for Canva)

============================================================

COMPLETED âœ…
------------
[âœ…] Python pipeline working locally (Agents A, B, C, D)
[âœ…] Webhook server created (webhook_server.py)
[âœ…] Google Cloud project created ("n8n-connector")
[âœ…] Google Drive API enabled
[âœ…] OAuth 2.0 credentials created (Web application)
[âœ…] Test user added to OAuth consent screen
[âœ…] Docker installed on Mac
[âœ…] n8n running locally (http://127.0.0.1:5678)
[âœ…] Webhook server running on port 5001
[âœ…] n8n workflow imported (StarTraining Pipeline)
[âœ…] Redirect URI added to Google Cloud Console
[âœ…] Node 1: Google Drive trigger connected (folder: 1ggqu326-4x_YghpkjTsrg9_AVKpr92Qt)
[âœ…] Node 3: Webhook URL configured (http://host.docker.internal:5001/run-single)
[âœ…] Pipeline test run successful (fixed agentB.py timeout issue)
[âœ…] Canva Developer Integration created
[âœ…] Canva Client ID and Client Secret obtained
[âœ…] Canva OAuth connected (PKCE + 127.0.0.1 fix applied)

============================================================

IN PROGRESS ğŸ”„
--------------
[ğŸ”„] DEBUG: Canva API not creating designs (Session ended Jan 4, 2026)
     â†’ Node 5 executes but returns NO OUTPUT (not even errors)
     â†’ Template confirmed as Brand Template: EAG9R2WwCkE
     â†’ Element names confirmed case-sensitive: DAY, DATE, SOURCE, Body

     NEXT SESSION - TRY THESE STEPS:
     1. Test Canva OAuth by creating a GET request node:
        URL: https://api.canva.com/rest/v1/brand-templates/EAG9R2WwCkE/dataset
        This will show the ACTUAL field names the template expects
     2. If OAuth fails, reconnect the Canva credential in n8n
     3. Compare the field names returned vs what we're sending
     4. Check n8n Executions tab for detailed error logs

============================================================

TODO âŒ
-------
[âŒ] Fix Canva API - Node 5 returns no output
[âŒ] Test complete workflow end-to-end
[âŒ] (Optional) Set up ngrok for external access

============================================================

WORKFLOW STRUCTURE (11 nodes)
-----------------------------
1. New File in Drive      â†’ Google Drive trigger
2. Extract Info           â†’ Parse filename for date/label
3. Run Python Pipeline    â†’ Call webhook_server.py
4. Pipeline Success?      â†’ IF node checks status
   â”œâ”€ True â†’ Update the Canva Design â†’ Loop Over Items
   â””â”€ False â†’ Pipeline Failed (NoOp)
5. Create Canva Design    â†’ Canva Autofill API (BLOCKED - no output)
6. Wait for Render        â†’ 10 seconds
7. Export Design          â†’ Request PNG export
8. Wait for Export        â†’ 15 seconds
9. Get Export URL         â†’ Get download URL
10. Collect Export URLs   â†’ Prepare data for email
11. Send Gmail            â†’ Notification email (replaced WhatsApp)

============================================================

CREDENTIALS STATUS
------------------

1. GOOGLE DRIVE âœ… CONNECTED
   - Client ID: 947653681876-b288b3b0m2ang0ucdlkrtqdjt2447sgi.apps.googleusercontent.com
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback

2. CANVA âœ… CONNECTED
   - Integration created at: https://www.canva.dev
   - Client ID: [saved in n8n]
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback
   - Grant Type: PKCE (required by Canva)
   - Scopes: asset:read design:content:read design:content:write brandtemplate:content:read

   CRITICAL FIX APPLIED:
   - Must use 127.0.0.1 (not localhost) - Canva rejects localhost
   - Must restart n8n with: -e WEBHOOK_URL=http://127.0.0.1:5678/
   - Must use PKCE grant type (not Authorization Code)

3. GMAIL âœ… CONNECTED
   - Using same Google Cloud project as Drive
   - Scope added: https://mail.google.com/
   - Sends notification to: rjaumecatany@gmail.com

============================================================

COMMANDS REFERENCE
------------------

Start n8n (Docker):
  docker start n8n
  # Then open http://localhost:5678

Stop n8n:
  docker stop n8n

Start webhook server:
  cd ~/GitHub/startraining-ai-pipeline
  source .venv/bin/activate
  PORT=5001 python webhook_server.py

Test webhook:
  curl http://localhost:5001/health

============================================================

URLS & PATHS
------------
n8n Local:           http://localhost:5678
Webhook Server:      http://localhost:5001
Google Cloud:        https://console.cloud.google.com
Canva Developers:    https://www.canva.dev
Meta Developers:     https://developers.facebook.com

============================================================

NEXT STEP - NAME CANVA TEMPLATE ELEMENTS
-----------------------------------------

Brand Template ID: EAG9R2WwCkE (already configured in n8n Node 5)

ISSUE: Canva returns "No matching fields in dataset" error.
CAUSE: Bulk Create {{placeholders}} don't work with Autofill API.
       The API needs ELEMENT NAMES, not placeholder text.

TO FIX:

1. Open your Brand Template in Canva

2. For each text element you want to auto-fill:
   â†’ Click the text element
   â†’ Open Layers panel (left sidebar) or Position panel (top right)
   â†’ Find "Element name" or "Layer name"
   â†’ Rename to match the API field name EXACTLY:

   | Element Name | What it displays |
   |--------------|------------------|
   | date         | Monday date (e.g., 20250113) |
   | source       | Week/Cycle label (e.g., Semana_1_Ciclo_7) |

3. Save the template (auto-saves)

4. If template ID changed, update n8n Node 5 body:
   "brand_template_id": "NEW_ID_HERE"

5. Test Node 5 in n8n again

NOTE: The text content INSIDE the element doesn't matter.
      Canva replaces the ENTIRE text with what the API sends.
      Only the ELEMENT NAME must match.

============================================================

BUG FIXES APPLIED
-----------------

agentB.py - Fixed Google Drive sync timeout
  - Problem: Writing CSV row-by-row caused timeout with Google Drive sync
  - Solution: Buffer all rows in memory, write once at end
  - File: ~/GitHub/startraining-ai-pipeline/agents/agentB.py

============================================================
