============================================================
STARTRAINING N8N AUTOMATION - PROJECT STATUS
============================================================
Date: January 7, 2026 (Updated)
============================================================

GOAL
----
Automate the StarTraining workout publishing pipeline:
1. Detect new Word file uploaded to Google Drive
2. Run Python pipeline (Agents Aâ†’Bâ†’Câ†’D) to extract & format workout data
3. Create Canva design from template using the CSV data
4. Send the design image via WhatsApp

============================================================

WORKFLOW OVERVIEW
-----------------
Node 1:  Google Drive Trigger    â†’ Watch for new .docx files
Node 2:  Code                    â†’ Extract date & label from filename
Node 3:  HTTP Request            â†’ Call webhook_server.py to run pipeline
Node 4:  IF                      â†’ Check if pipeline succeeded
Node 5:  HTTP Request            â†’ Canva: Create design from template
Node 6:  Wait                    â†’ Wait for Canva to render
Node 7:  HTTP Request            â†’ Canva: Export design as PNG
Node 8:  Wait                    â†’ Wait for export
Node 9:  HTTP Request            â†’ Canva: Get export URL
Node 10: HTTP Request            â†’ WhatsApp: Send image

============================================================

DIRECTORY STRUCTURE
-------------------
Keep n8n and Python pipeline SEPARATE:

~/
â”œâ”€â”€ startraining-ai-pipeline/    â† Python scripts (your repo)
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ agentA.py
â”‚   â”‚   â”œâ”€â”€ agentB.py            â† Fixed: buffered CSV writing
â”‚   â”‚   â”œâ”€â”€ agentC.py
â”‚   â”‚   â””â”€â”€ agentD.py
â”‚   â”œâ”€â”€ webhook_server.py
â”‚   â”œâ”€â”€ run_pipeline.py
â”‚   â”œâ”€â”€ run_all_pipeline.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ .n8n/                        â† n8n data (auto-created by Docker)
â”‚   â”œâ”€â”€ database.sqlite          â† Workflows, credentials
â”‚   â””â”€â”€ config                   â† n8n settings
â”‚
â””â”€â”€ Google Drive/
    â””â”€â”€ Blackboard/
        â”œâ”€â”€ Raw/                 â† Upload .docx files here
        â”œâ”€â”€ AgentA/              â† AgentA output
        â”œâ”€â”€ AgentB/              â† AgentB output
        â”œâ”€â”€ AgentC/              â† AgentC output (pivoted)
        â””â”€â”€ AgentD/              â† AgentD output (for Canva)

============================================================

COMPLETED âœ…
------------
[âœ…] Python pipeline working locally (Agents A, B, C, D)
[âœ…] Webhook server created (webhook_server.py)
[âœ…] Google Cloud project created ("n8n-connector")
[âœ…] Google Drive API enabled
[âœ…] OAuth 2.0 credentials created (Web application)
[âœ…] Test user added to OAuth consent screen
[âœ…] Docker installed on Mac
[âœ…] n8n running locally (http://127.0.0.1:5678)
[âœ…] Webhook server running on port 5001
[âœ…] n8n workflow imported (StarTraining Pipeline)
[âœ…] Redirect URI added to Google Cloud Console
[âœ…] Node 1: Google Drive trigger connected (folder: 1ggqu326-4x_YghpkjTsrg9_AVKpr92Qt)
[âœ…] Node 3: Webhook URL configured (http://host.docker.internal:5001/run-single)
[âœ…] Pipeline test run successful (fixed agentB.py timeout issue)
[âœ…] Canva Developer Integration created
[âœ…] Canva Client ID and Client Secret obtained
[âœ…] Canva OAuth connected (PKCE + 127.0.0.1 fix applied)

============================================================

IN PROGRESS ğŸ”„
--------------
[ğŸ”„] FIXED: Canva API field mapping corrected (Session Jan 7, 2026)
     â†’ Root cause: Field names were CASE-SENSITIVE and mismatched
     â†’ Template elements: DAY, DATE, SOURCE, Body
     â†’ CSV columns: Day, Date, Source, Exercise

     CHANGES MADE (Jan 7, 2026):
     1. Updated "Update the Canva Design" code node in workflow v1.1
     2. Field mapping: Dayâ†’DAY, Dateâ†’DATE, Sourceâ†’SOURCE, Exerciseâ†’Body
     3. Node 5 JSON body already correct (DAY, DATE, SOURCE, Body)

     NEXT STEPS:
     1. Re-import workflow v1.1 in n8n (or delete and import fresh)
     2. Test Node 5 with the corrected field mapping
     3. Run complete end-to-end test

============================================================

TODO âŒ
-------
[âŒ] Re-import workflow v1.1 in n8n
[âŒ] Test complete workflow end-to-end
[âŒ] (Optional) Set up ngrok for external access

============================================================

WORKFLOW STRUCTURE (11 nodes)
-----------------------------
1. New File in Drive      â†’ Google Drive trigger
2. Extract Info           â†’ Parse filename for date/label
3. Run Python Pipeline    â†’ Call webhook_server.py
4. Pipeline Success?      â†’ IF node checks status
   â”œâ”€ True â†’ Update the Canva Design â†’ Loop Over Items
   â””â”€ False â†’ Pipeline Failed (NoOp)
5. Create Canva Design    â†’ Canva Autofill API (BLOCKED - no output)
6. Wait for Render        â†’ 10 seconds
7. Export Design          â†’ Request PNG export
8. Wait for Export        â†’ 15 seconds
9. Get Export URL         â†’ Get download URL
10. Collect Export URLs   â†’ Prepare data for email
11. Send Gmail            â†’ Notification email (replaced WhatsApp)

============================================================

CREDENTIALS STATUS
------------------

1. GOOGLE DRIVE âœ… CONNECTED
   - Client ID: 947653681876-b288b3b0m2ang0ucdlkrtqdjt2447sgi.apps.googleusercontent.com
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback

2. CANVA âœ… CONNECTED
   - Integration created at: https://www.canva.dev
   - Client ID: [saved in n8n]
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback
   - Grant Type: PKCE (required by Canva)
   - Scopes: asset:read design:content:read design:content:write brandtemplate:content:read

   CRITICAL FIX APPLIED:
   - Must use 127.0.0.1 (not localhost) - Canva rejects localhost
   - Must restart n8n with: -e WEBHOOK_URL=http://127.0.0.1:5678/
   - Must use PKCE grant type (not Authorization Code)

3. GMAIL âœ… CONNECTED
   - Using same Google Cloud project as Drive
   - Scope added: https://mail.google.com/
   - Sends notification to: rjaumecatany@gmail.com

============================================================

COMMANDS REFERENCE
------------------

Start n8n (Docker):
  docker start n8n
  # Then open http://127.0.0.1:5678/workflow/C7u3mf7UQ9Tnr6EI

Stop n8n:
  docker stop n8n

Start webhook server:
  cd ~/GitHub/startraining-ai-pipeline
  source .venv/bin/activate
  PORT=5001 python webhook_server.py

Test webhook:
  curl http://localhost:5001/health

============================================================

URLS & PATHS
------------
n8n Local:           http://127.0.0.1:5678
StarTraining Flow:   http://127.0.0.1:5678/workflow/C7u3mf7UQ9Tnr6EI
Webhook Server:      http://localhost:5001
Google Cloud:        https://console.cloud.google.com
Canva Developers:    https://www.canva.dev
Meta Developers:     https://developers.facebook.com

============================================================

NEXT STEP - RE-IMPORT WORKFLOW AND TEST
---------------------------------------

Brand Template ID: EAG9R2WwCkE

Template elements and their CSV mappings:
| Element | CSV Column | Example Value |
|---------|------------|---------------|
| DAY     | Day        | Monday        |
| DATE    | Date       | 20250113      |
| SOURCE  | Source     | Semana_1_Ciclo_7 |
| Body    | Exercise   | Back Squat... |

TO TEST:

1. Open n8n: http://127.0.0.1:5678

2. Delete existing workflow (or import as new):
   Workflows â†’ ... menu â†’ Delete

3. Import updated workflow:
   Workflows â†’ Import from File
   Select: workflows/startraining_canva_workflow_v1.1.json

4. Re-connect credentials if needed:
   - Google Drive account
   - Canva OAuth2 (Unnamed credential)
   - Gmail account

5. Start webhook server:
   cd ~/GitHub/startraining-ai-pipeline
   source .venv/bin/activate
   PORT=5001 python webhook_server.py

6. Test by uploading a .docx to Google Drive Raw/ folder

============================================================

BUG FIXES APPLIED
-----------------

agentB.py - Fixed Google Drive sync timeout
  - Problem: Writing CSV row-by-row caused timeout with Google Drive sync
  - Solution: Buffer all rows in memory, write once at end
  - File: ~/GitHub/startraining-ai-pipeline/agents/agentB.py

============================================================
