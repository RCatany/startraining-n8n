============================================================
STARTRAINING N8N AUTOMATION - PROJECT STATUS
============================================================
Date: January 11, 2026 (Updated)
============================================================

GOAL
----
Automate the StarTraining workout publishing pipeline:
1. Detect new Word file uploaded to Google Drive
2. Run Python pipeline (Agents Aâ†’Bâ†’Câ†’D) to extract & format workout data
3. Create Canva design from template using the CSV data
4. Send the design image via WhatsApp

============================================================

WORKFLOW VERSION HISTORY
-------------------------
v1.0 - Initial workflow (basic pipeline integration)
v1.1 - Added Canva API integration with field mapping fixes
v1.2 - MAIN/STRENGTH folder separation implemented
v1.3.7 - Multiple email bug FIXED (current stable version)
       â†’ Added "Aggregate Results" node to consolidate loop output
       â†’ Single email notification with links to both folders
       â†’ Filename format: YYYYMMDD_Day_TYPE.png
       â†’ All features working end-to-end

============================================================

WORKFLOW OVERVIEW
-----------------
Node 1:  Google Drive Trigger    â†’ Watch for new .docx files
Node 2:  Code                    â†’ Extract date & label from filename
Node 3:  HTTP Request            â†’ Call webhook_server.py to run pipeline
Node 4:  IF                      â†’ Check if pipeline succeeded
Node 5:  HTTP Request            â†’ Canva: Create design from template
Node 6:  Wait                    â†’ Wait for Canva to render
Node 7:  HTTP Request            â†’ Canva: Export design as PNG
Node 8:  Wait                    â†’ Wait for export
Node 9:  HTTP Request            â†’ Canva: Get export URL
Node 10: HTTP Request            â†’ WhatsApp: Send image

============================================================

DIRECTORY STRUCTURE
-------------------
Keep n8n and Python pipeline SEPARATE:

~/
â”œâ”€â”€ startraining-ai-pipeline/    â† Python scripts (your repo)
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ agentA.py
â”‚   â”‚   â”œâ”€â”€ agentB.py            â† Fixed: buffered CSV writing
â”‚   â”‚   â”œâ”€â”€ agentC.py
â”‚   â”‚   â””â”€â”€ agentD.py
â”‚   â”œâ”€â”€ webhook_server.py
â”‚   â”œâ”€â”€ run_pipeline.py
â”‚   â”œâ”€â”€ run_all_pipeline.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ .n8n/                        â† n8n data (auto-created by Docker)
â”‚   â”œâ”€â”€ database.sqlite          â† Workflows, credentials
â”‚   â””â”€â”€ config                   â† n8n settings
â”‚
â””â”€â”€ Google Drive/
    â””â”€â”€ Blackboard/
        â”œâ”€â”€ Raw/                 â† Upload .docx files here
        â”œâ”€â”€ AgentA/              â† AgentA output
        â”œâ”€â”€ AgentB/              â† AgentB output
        â”œâ”€â”€ AgentC/              â† AgentC output (pivoted)
        â””â”€â”€ AgentD/              â† AgentD output (for Canva)

============================================================

COMPLETED âœ…
------------
[âœ…] Python pipeline working locally (Agents A, B, C, D)
[âœ…] Webhook server created (webhook_server.py)
[âœ…] Google Cloud project created ("n8n-connector")
[âœ…] Google Drive API enabled
[âœ…] OAuth 2.0 credentials created (Web application)
[âœ…] Test user added to OAuth consent screen
[âœ…] Docker installed on Mac
[âœ…] n8n running locally (http://127.0.0.1:5678)
[âœ…] Webhook server running on port 5001
[âœ…] n8n workflow imported (StarTraining Pipeline)
[âœ…] Redirect URI added to Google Cloud Console
[âœ…] Node 1: Google Drive trigger connected (folder: 1ggqu326-4x_YghpkjTsrg9_AVKpr92Qt)
[âœ…] Node 3: Webhook URL configured (http://host.docker.internal:5001/run-single)
[âœ…] Pipeline test run successful (fixed agentB.py timeout issue)
[âœ…] Canva Developer Integration created
[âœ…] Canva Client ID and Client Secret obtained
[âœ…] Canva OAuth connected (PKCE + 127.0.0.1 fix applied)
[âœ…] Workflow v1.3.7 COMPLETED (Jan 11, 2026)
     â†’ MAIN and STRENGTH folder separation working
     â†’ Canva design generation with autofill working
     â†’ Multiple email bug FIXED (7 emails â†’ 1 email)
     â†’ Filename format correct: YYYYMMDD_Day_TYPE.png

============================================================

IN PROGRESS ðŸ”„
--------------
[ðŸ”„] Cerrar workflow phase (Jan 11, 2026)
     â†’ Awaiting email address from Miguel for Google Drive sharing
     â†’ Awaiting direct access to RAW files folder for Miguel
     â†’ Email notification functionality working in v1.3.7

============================================================

TODO âŒ
-------
[âŒ] WhatsApp Business API integration
[âŒ] AimHarder text generation integration
[âŒ] (Optional) Set up ngrok for external access

============================================================

FUTURE DEVELOPMENT - SaaS/COMMERCIAL VIABILITY
-----------------------------------------------

STRATEGIC INITIATIVE: Input Document Alternatives
--------------------------------------------------
Goal: Evaluate alternatives to current Word document input (RAW folder)
      to enable conversion into SaaS product or sellable service.

CANDIDATE SOLUTIONS:

1. Word Template
   - Structured .docx template with predefined fields
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

2. Notion Database
   - Web-based, collaborative, API-accessible
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

3. Excel/Google Sheets
   - Spreadsheet format, easy data validation, API available
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

4. Custom Web Form
   - Direct input via web interface
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

5. Mobile App Input
   - Native app for coaches to input workout data
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

6. Airtable
   - Database with forms, API, and automations
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

7. Typeform/Google Forms
   - Simple form-based input with integrations
   - Evaluate: Ease of use, API accessibility, data validation,
     scalability, cost, integration complexity

EVALUATION CRITERIA:
1. Ease of use for end users (coaches)
2. API accessibility for automation
3. Data validation capabilities
4. Multi-user/multi-gym scalability
5. Cost structure for SaaS model
6. Integration complexity with current pipeline

STRATEGIC CONTEXT:
Transform workflow from personal automation â†’ commercial product
serving multiple gyms/coaches simultaneously.

============================================================

WORKFLOW STRUCTURE v1.3.7 (Working)
------------------------------------
1. Google Drive Trigger        â†’ Detects new .docx in Raw/ folder
2. Code Node                   â†’ Extracts date/label from filename
3. HTTP Request                â†’ Calls webhook at http://host.docker.internal:5001/run-single
4. IF Node                     â†’ Checks if pipeline succeeded
5. Create Folder (MAIN)        â†’ Creates MAIN output folder in Google Drive
6. Create Folder (STRENGTH)    â†’ Creates STRENGTH output folder in Google Drive
7. Loop Over Items             â†’ SplitInBatches processes each day's workout (7 items)
8. Prepare Canva Request       â†’ Builds autofill request body
9. Create Canva Design         â†’ POST to /rest/v1/autofills
10. Wait for Render            â†’ 10 seconds
11. Get Autofill Result        â†’ Polls job to get design ID
12. Export Design              â†’ POST to /rest/v1/exports
13. Wait for Export            â†’ 15 seconds
14. Get Export URL             â†’ Gets download URLs from job.urls[]
15. Download PNG               â†’ Downloads exported image
16. Route to Folder            â†’ Routes based on Type field (MAIN/STRENGTH)
17. Upload to Drive            â†’ Saves PNG to correct folder
18. Aggregate Results          â†’ Combines 7 items into 1 summary (FIX for email bug)
19. Send Gmail                 â†’ Single notification email with both folder links

============================================================

CREDENTIALS STATUS
------------------

1. GOOGLE DRIVE âœ… CONNECTED
   - Client ID: 947653681876-b288b3b0m2ang0ucdlkrtqdjt2447sgi.apps.googleusercontent.com
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback

2. CANVA âœ… CONNECTED
   - Integration created at: https://www.canva.dev
   - Client ID: [saved in n8n]
   - Client Secret: [saved in n8n]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback
   - Grant Type: PKCE (required by Canva)
   - Scopes: asset:read design:content:read design:content:write brandtemplate:content:read

   CRITICAL FIX APPLIED:
   - Must use 127.0.0.1 (not localhost) - Canva rejects localhost
   - Must restart n8n with: -e WEBHOOK_URL=http://127.0.0.1:5678/
   - Must use PKCE grant type (not Authorization Code)

3. GMAIL âœ… CONNECTED
   - Using same Google Cloud project as Drive
   - Scope added: https://mail.google.com/
   - Sends notification to: rjaumecatany@gmail.com

============================================================

COMMANDS REFERENCE
------------------

Start n8n (Docker):
  docker start n8n
  # Then open http://127.0.0.1:5678/workflow/C7u3mf7UQ9Tnr6EI

Stop n8n:
  docker stop n8n

Start webhook server:
  cd ~/GitHub/startraining-ai-pipeline
  source .venv/bin/activate
  PORT=5001 python webhook_server.py

Test webhook:
  curl http://localhost:5001/health

============================================================

URLS & PATHS
------------
n8n Local:           http://127.0.0.1:5678
StarTraining Flow:   http://127.0.0.1:5678/workflow/C7u3mf7UQ9Tnr6EI
Webhook Server:      http://localhost:5001
Google Cloud:        https://console.cloud.google.com
Canva Developers:    https://www.canva.dev
Meta Developers:     https://developers.facebook.com

============================================================

NEXT STEP - RE-IMPORT WORKFLOW AND TEST
---------------------------------------

Brand Template ID: EAG9R2WwCkE

Template elements and their CSV mappings:
| Element | CSV Column | Example Value |
|---------|------------|---------------|
| DAY     | Day        | Monday        |
| DATE    | Date       | 20250113      |
| SOURCE  | Source     | Semana_1_Ciclo_7 |
| Body    | Exercise   | Back Squat... |

TO TEST:

1. Open n8n: http://127.0.0.1:5678

2. Delete existing workflow (or import as new):
   Workflows â†’ ... menu â†’ Delete

3. Import updated workflow:
   Workflows â†’ Import from File
   Select: workflows/startraining_canva_workflow_v1.1.json

4. Re-connect credentials if needed:
   - Google Drive account
   - Canva OAuth2 (Unnamed credential)
   - Gmail account

5. Start webhook server:
   cd ~/GitHub/startraining-ai-pipeline
   source .venv/bin/activate
   PORT=5001 python webhook_server.py

6. Test by uploading a .docx to Google Drive Raw/ folder

============================================================

BUG FIXES APPLIED
-----------------

1. agentB.py - Fixed Google Drive sync timeout (Jan 7, 2026)
   - Problem: Writing CSV row-by-row caused timeout with Google Drive sync
   - Solution: Buffer all rows in memory, write once at end
   - File: ~/GitHub/startraining-ai-pipeline/agents/agentB.py

2. Multiple Email Bug - FIXED (Jan 11, 2026)
   - Problem: Workflow sent 7 emails instead of 1 after processing all workouts
   - Root Cause: SplitInBatches "Done" output passes ALL processed items (7) to next node
     â†’ Gmail node received 7 items and executed once per item = 7 emails
   - Failed Analysis: Codex and Gemini AI agents initially provided incorrect analysis
     â†’ Their reports have been updated with corrections
   - Solution: Added "Aggregate Results" Code node between Loop Done and Gmail
     â†’ Flow: Loop Done (7 items) â†’ Aggregate Results (1 item) â†’ Send Email (1 email)
   - Implementation:
     ```javascript
     // Aggregate Results node
     const allItems = $input.all();
     const mainFolderId = allItems[0].json.mainFolderId;
     const strengthFolderId = allItems[0].json.strengthFolderId;
     const uploadedFiles = allItems.map(item => ({
       name: item.json.fileName,
       type: item.json.type
     }));

     return {
       json: {
         mainFolderId,
         strengthFolderId,
         uploadedFiles,
         totalFiles: uploadedFiles.length
       }
     };
     ```
   - Status: VERIFIED WORKING in v1.3.7

============================================================
