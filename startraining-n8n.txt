============================================================
STARTRAINING N8N AUTOMATION - PROJECT STATUS
============================================================
Date: December 29, 2025 (Updated)
============================================================

GOAL
----
Automate the StarTraining workout publishing pipeline:
1. Detect new Word file uploaded to Google Drive
2. Run Python pipeline (Agents Aâ†’Bâ†’Câ†’D) to extract & format workout data
3. Create Canva design from template using the CSV data
4. Send the design image via WhatsApp

============================================================

WORKFLOW OVERVIEW
-----------------
Node 1:  Google Drive Trigger    â†’ Watch for new .docx files
Node 2:  Code                    â†’ Extract date & label from filename
Node 3:  HTTP Request            â†’ Call webhook_server.py to run pipeline
Node 4:  IF                      â†’ Check if pipeline succeeded
Node 5:  HTTP Request            â†’ Canva: Create design from template
Node 6:  Wait                    â†’ Wait for Canva to render
Node 7:  HTTP Request            â†’ Canva: Export design as PNG
Node 8:  Wait                    â†’ Wait for export
Node 9:  HTTP Request            â†’ Canva: Get export URL
Node 10: HTTP Request            â†’ WhatsApp: Send image

============================================================

DIRECTORY STRUCTURE
-------------------
Keep n8n and Python pipeline SEPARATE:

~/
â”œâ”€â”€ startraining-ai-pipeline/    â† Python scripts (your repo)
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ agentA.py
â”‚   â”‚   â”œâ”€â”€ agentB.py            â† Fixed: buffered CSV writing
â”‚   â”‚   â”œâ”€â”€ agentC.py
â”‚   â”‚   â””â”€â”€ agentD.py
â”‚   â”œâ”€â”€ webhook_server.py
â”‚   â”œâ”€â”€ run_pipeline.py
â”‚   â”œâ”€â”€ run_all_pipeline.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ .n8n/                        â† n8n data (auto-created by Docker)
â”‚   â”œâ”€â”€ database.sqlite          â† Workflows, credentials
â”‚   â””â”€â”€ config                   â† n8n settings
â”‚
â””â”€â”€ Google Drive/
    â””â”€â”€ Blackboard/
        â”œâ”€â”€ Raw/                 â† Upload .docx files here
        â”œâ”€â”€ AgentA/              â† AgentA output
        â”œâ”€â”€ AgentB/              â† AgentB output
        â”œâ”€â”€ AgentC/              â† AgentC output (pivoted)
        â””â”€â”€ AgentD/              â† AgentD output (for Canva)

============================================================

COMPLETED âœ…
------------
[âœ…] Python pipeline working locally (Agents A, B, C, D)
[âœ…] Webhook server created (webhook_server.py)
[âœ…] Google Cloud project created ("n8n-connector")
[âœ…] Google Drive API enabled
[âœ…] OAuth 2.0 credentials created (Web application)
[âœ…] Test user added to OAuth consent screen
[âœ…] Docker installed on Mac
[âœ…] n8n running locally (http://localhost:5678)
[âœ…] Webhook server running on port 5001
[âœ…] n8n workflow imported (StarTraining Pipeline)
[âœ…] Redirect URI added to Google Cloud Console
[âœ…] Node 1: Google Drive trigger connected (folder: 1ggqu326-4x_YghpkjTsrg9_AVKpr92Qt)
[âœ…] Node 3: Webhook URL configured (http://host.docker.internal:5001/run-single)
[âœ…] Pipeline test run successful (fixed agentB.py timeout issue)
[âœ…] Canva Developer App created
[âœ…] Canva Client ID and Client Secret obtained

============================================================

IN PROGRESS ğŸ”„
--------------
[ğŸ”„] Node 5: Canva OAuth connection
     â†’ Getting "Unauthorized" error
     â†’ Need to complete Canva app setup (see NEXT STEP below)

============================================================

TODO âŒ
-------
[âŒ] Node 5: Complete Canva OAuth connection
[âŒ] Node 5: Get Canva template ID for workout design
[âŒ] Node 10: Set up WhatsApp credentials
[âŒ] Node 10: Add recipient phone number
[âŒ] Test complete workflow end-to-end
[âŒ] (Optional) Set up ngrok for external access

============================================================

CREDENTIALS STATUS
------------------

1. GOOGLE DRIVE âœ… CONNECTED
   - Client ID: 947653681876-b288b3b0m2ang0ucdlkrtqdjt2447sgi.apps.googleusercontent.com
   - Client Secret: [saved in n8n]
   - Redirect URI: http://localhost:5678/rest/oauth2-credential/callback

2. CANVA ğŸ”„ IN PROGRESS
   - App created at: https://www.canva.dev
   - Client ID: [saved - you have it]
   - Client Secret: [saved - you have it]
   - Redirect URI: http://127.0.0.1:5678/rest/oauth2-credential/callback
   - Required scopes: design:content:read design:content:write asset:read brandtemplate:content:read

   ISSUE: Getting "Unauthorized" error when connecting

3. WHATSAPP (not started)
   - Get from: https://developers.facebook.com
   - Need: Phone Number ID
   - Need: Access Token
   - Recipient phone number (format: 34612345678)

============================================================

COMMANDS REFERENCE
------------------

Start n8n (Docker):
  docker start n8n
  # Then open http://localhost:5678

Stop n8n:
  docker stop n8n

Start webhook server:
  cd ~/GitHub/startraining-ai-pipeline
  source .venv/bin/activate
  PORT=5001 python webhook_server.py

Test webhook:
  curl http://localhost:5001/health

============================================================

URLS & PATHS
------------
n8n Local:           http://localhost:5678
Webhook Server:      http://localhost:5001
Google Cloud:        https://console.cloud.google.com
Canva Developers:    https://www.canva.dev
Meta Developers:     https://developers.facebook.com

============================================================

NEXT STEP - FIX CANVA OAUTH
---------------------------

The Canva OAuth is returning "Unauthorized". To fix:

1. Go to Canva Developer Portal: https://www.canva.dev
   â†’ Your Apps â†’ Select your app

2. CHECK TEST USERS (Required for development apps!)
   â†’ Go to "Test users" section
   â†’ Add your Canva account email as a test user
   â†’ This is REQUIRED before you can authenticate

3. VERIFY REDIRECT URI (must match exactly)
   â†’ Settings â†’ Authentication â†’ Redirect URLs
   â†’ Must be: http://127.0.0.1:5678/rest/oauth2-credential/callback
   â†’ No trailing slash, must use 127.0.0.1 (not localhost)

4. VERIFY SCOPES ARE ENABLED
   â†’ Settings â†’ Scopes
   â†’ Enable: design:content:read, design:content:write,
             asset:read, brandtemplate:content:read

5. IN N8N - USE PKCE GRANT TYPE
   â†’ Credentials â†’ Edit Canva credential
   â†’ Change "Grant Type" to "PKCE" (not "Authorization Code")
   â†’ Authorization URL: https://www.canva.com/api/oauth/authorize
   â†’ Access Token URL: https://api.canva.com/rest/v1/oauth/token
   â†’ Authentication: Body

6. Click "Connect my account" and try again

============================================================

BUG FIXES APPLIED
-----------------

agentB.py - Fixed Google Drive sync timeout
  - Problem: Writing CSV row-by-row caused timeout with Google Drive sync
  - Solution: Buffer all rows in memory, write once at end
  - File: ~/GitHub/startraining-ai-pipeline/agents/agentB.py

============================================================
